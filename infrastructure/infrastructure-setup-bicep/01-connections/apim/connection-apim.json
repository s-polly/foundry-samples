{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "3070388862604795803"
    }
  },
  "parameters": {
    "projectResourceId": {
      "type": "string",
      "defaultValue": "/subscriptions/12345678-1234-1234-1234-123456789abc/resourceGroups/rg-sample/providers/Microsoft.CognitiveServices/accounts/sample-foundry-account/projects/sample-project",
      "metadata": {
        "description": "Resource ID of the AI Foundry project"
      }
    },
    "apimResourceId": {
      "type": "string",
      "defaultValue": "/subscriptions/12345678-1234-1234-1234-123456789abc/resourceGroups/rg-sample/providers/Microsoft.ApiManagement/service/sample-apim",
      "metadata": {
        "description": "Resource ID of the APIM service"
      }
    },
    "apiName": {
      "type": "string",
      "defaultValue": "sample-api",
      "metadata": {
        "description": "Name of the API in APIM"
      }
    },
    "connectionName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Name for the connection (auto-generated if empty)"
      }
    },
    "apimSubscriptionName": {
      "type": "string",
      "defaultValue": "master",
      "metadata": {
        "description": "APIM subscription name for API key auth"
      }
    },
    "authType": {
      "type": "string",
      "defaultValue": "ApiKey",
      "allowedValues": [
        "ApiKey"
      ],
      "metadata": {
        "description": "Authentication type"
      }
    },
    "isSharedToAll": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Share connection to all project users"
      }
    },
    "deploymentInPath": {
      "type": "string",
      "defaultValue": "true",
      "allowedValues": [
        "true",
        "false"
      ],
      "metadata": {
        "description": "Whether deployment name is in URL path vs query parameter"
      }
    },
    "inferenceAPIVersion": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "API version for inference calls (chat completions, embeddings)"
      }
    },
    "deploymentAPIVersion": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "API version for deployment management (optional)"
      }
    },
    "listModelsEndpoint": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Endpoint for listing models (enables dynamic discovery)"
      }
    },
    "getModelEndpoint": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Endpoint for getting model details (enables dynamic discovery)"
      }
    },
    "deploymentProvider": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Provider for model discovery (AzureOpenAI, etc.)"
      }
    },
    "staticModels": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Static model list (array of model objects, optional)"
      }
    },
    "customHeaders": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Custom headers (object with string key-value pairs, optional)"
      }
    },
    "authConfig": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Authentication configuration (object for custom auth headers)"
      }
    }
  },
  "variables": {
    "apimServiceName": "[split(parameters('apimResourceId'), '/')[8]]",
    "generatedConnectionName": "[format('apim-{0}-{1}', variables('apimServiceName'), parameters('apiName'))]",
    "finalConnectionName": "[if(not(equals(parameters('connectionName'), '')), parameters('connectionName'), variables('generatedConnectionName'))]",
    "hasDeploymentAPIVersion": "[not(equals(parameters('deploymentAPIVersion'), ''))]",
    "hasInferenceAPIVersion": "[not(equals(parameters('inferenceAPIVersion'), ''))]",
    "hasModelDiscovery": "[and(and(not(equals(parameters('listModelsEndpoint'), '')), not(equals(parameters('getModelEndpoint'), ''))), not(equals(parameters('deploymentProvider'), '')))]",
    "hasStaticModels": "[greater(length(parameters('staticModels')), 0)]",
    "hasCustomHeaders": "[not(empty(parameters('customHeaders')))]",
    "hasAuthConfig": "[not(empty(parameters('authConfig')))]",
    "bothConfiguredError": "[and(variables('hasModelDiscovery'), variables('hasStaticModels'))]",
    "validationMessage": "[if(variables('bothConfiguredError'), 'ERROR: Cannot configure both static models and dynamic discovery. Use either staticModels array OR modelDiscovery parameters, not both.', '')]",
    "neitherConfiguredError": "[and(not(variables('hasModelDiscovery')), not(variables('hasStaticModels')))]",
    "neitherConfiguredMessage": "ERROR: Must configure either static models (staticModels array) OR dynamic discovery (listModelsEndpoint, getModelEndpoint, deploymentProvider). Cannot have neither.",
    "metadata": "[union(createObject('deploymentInPath', parameters('deploymentInPath')), if(variables('hasInferenceAPIVersion'), createObject('inferenceAPIVersion', parameters('inferenceAPIVersion')), createObject()), if(variables('hasDeploymentAPIVersion'), createObject('deploymentAPIVersion', parameters('deploymentAPIVersion')), createObject()), if(variables('hasModelDiscovery'), createObject('modelDiscovery', string(createObject('listModelsEndpoint', parameters('listModelsEndpoint'), 'getModelEndpoint', parameters('getModelEndpoint'), 'deploymentProvider', parameters('deploymentProvider')))), createObject()), if(and(variables('hasStaticModels'), not(variables('hasModelDiscovery'))), createObject('models', string(parameters('staticModels'))), createObject()), if(variables('hasCustomHeaders'), createObject('customHeaders', string(parameters('customHeaders'))), createObject()), if(variables('hasAuthConfig'), createObject('authConfig', string(parameters('authConfig'))), createObject()))]"
  },
  "resources": [
    {
      "condition": "[variables('bothConfiguredError')]",
      "type": "Microsoft.Resources/deploymentScripts",
      "apiVersion": "2023-08-01",
      "name": "[format('validation-error-{0}', uniqueString(resourceGroup().id))]",
      "location": "[resourceGroup().location]",
      "kind": "AzurePowerShell",
      "properties": {
        "azPowerShellVersion": "8.0",
        "scriptContent": "[format('throw \"{0}\"', variables('validationMessage'))]",
        "retentionInterval": "PT1H"
      }
    },
    {
      "condition": "[variables('neitherConfiguredError')]",
      "type": "Microsoft.Resources/deploymentScripts",
      "apiVersion": "2023-08-01",
      "name": "[format('config-validation-error-{0}', uniqueString(resourceGroup().id))]",
      "location": "[resourceGroup().location]",
      "kind": "AzurePowerShell",
      "properties": {
        "azPowerShellVersion": "8.0",
        "scriptContent": "[format('throw \"{0}\"', variables('neitherConfiguredMessage'))]",
        "retentionInterval": "PT1H"
      }
    },
    {
      "condition": "[and(not(variables('bothConfiguredError')), not(variables('neitherConfiguredError')))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "unified-apim-connection",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "projectResourceId": {
            "value": "[parameters('projectResourceId')]"
          },
          "connectionName": {
            "value": "[variables('finalConnectionName')]"
          },
          "apimResourceId": {
            "value": "[parameters('apimResourceId')]"
          },
          "apiName": {
            "value": "[parameters('apiName')]"
          },
          "apimSubscriptionName": {
            "value": "[parameters('apimSubscriptionName')]"
          },
          "authType": {
            "value": "[parameters('authType')]"
          },
          "isSharedToAll": {
            "value": "[parameters('isSharedToAll')]"
          },
          "metadata": {
            "value": "[variables('metadata')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "555869061841630591"
            }
          },
          "parameters": {
            "projectResourceId": {
              "type": "string"
            },
            "connectionName": {
              "type": "string"
            },
            "apimResourceId": {
              "type": "string"
            },
            "apiName": {
              "type": "string"
            },
            "apimSubscriptionName": {
              "type": "string",
              "defaultValue": "master"
            },
            "authType": {
              "type": "string",
              "defaultValue": "ApiKey"
            },
            "isSharedToAll": {
              "type": "bool",
              "defaultValue": false
            },
            "metadata": {
              "type": "object"
            }
          },
          "variables": {
            "aiFoundryName": "[split(parameters('projectResourceId'), '/')[8]]",
            "projectName": "[split(parameters('projectResourceId'), '/')[10]]",
            "apimSubscriptionId": "[split(parameters('apimResourceId'), '/')[2]]",
            "apimResourceGroupName": "[split(parameters('apimResourceId'), '/')[4]]",
            "apimServiceName": "[split(parameters('apimResourceId'), '/')[8]]"
          },
          "resources": [
            {
              "condition": "[equals(parameters('authType'), 'ApiKey')]",
              "type": "Microsoft.CognitiveServices/accounts/projects/connections",
              "apiVersion": "2025-04-01-preview",
              "name": "[format('{0}/{1}/{2}', variables('aiFoundryName'), variables('projectName'), parameters('connectionName'))]",
              "properties": {
                "category": "ApiManagement",
                "target": "[format('{0}/{1}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('apimSubscriptionId'), variables('apimResourceGroupName')), 'Microsoft.ApiManagement/service', variables('apimServiceName')), '2021-08-01').gatewayUrl, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('apimSubscriptionId'), variables('apimResourceGroupName')), 'Microsoft.ApiManagement/service/apis', variables('apimServiceName'), parameters('apiName')), '2021-08-01').path)]",
                "authType": "ApiKey",
                "isSharedToAll": "[parameters('isSharedToAll')]",
                "credentials": {
                  "key": "[listSecrets(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('apimSubscriptionId'), variables('apimResourceGroupName')), 'Microsoft.ApiManagement/service/subscriptions', variables('apimServiceName'), parameters('apimSubscriptionName')), '2021-08-01').primaryKey]"
                },
                "metadata": "[parameters('metadata')]"
              }
            }
          ],
          "outputs": {
            "connectionName": {
              "type": "string",
              "value": "[if(equals(parameters('authType'), 'ApiKey'), parameters('connectionName'), '')]"
            },
            "connectionId": {
              "type": "string",
              "value": "[if(equals(parameters('authType'), 'ApiKey'), resourceId('Microsoft.CognitiveServices/accounts/projects/connections', variables('aiFoundryName'), variables('projectName'), parameters('connectionName')), '')]"
            },
            "targetUrl": {
              "type": "string",
              "value": "[format('{0}/{1}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('apimSubscriptionId'), variables('apimResourceGroupName')), 'Microsoft.ApiManagement/service', variables('apimServiceName')), '2021-08-01').gatewayUrl, reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', variables('apimSubscriptionId'), variables('apimResourceGroupName')), 'Microsoft.ApiManagement/service/apis', variables('apimServiceName'), parameters('apiName')), '2021-08-01').path)]"
            },
            "authType": {
              "type": "string",
              "value": "[parameters('authType')]"
            },
            "metadata": {
              "type": "object",
              "value": "[parameters('metadata')]"
            }
          }
        }
      }
    }
  ],
  "outputs": {
    "connectionName": {
      "type": "string",
      "metadata": {
        "description": "Name of the created connection"
      },
      "value": "[variables('finalConnectionName')]"
    },
    "metadata": {
      "type": "object",
      "metadata": {
        "description": "Final metadata configuration"
      },
      "value": "[variables('metadata')]"
    },
    "authType": {
      "type": "string",
      "metadata": {
        "description": "Authentication type used"
      },
      "value": "[parameters('authType')]"
    },
    "hasStaticModels": {
      "type": "bool",
      "value": "[variables('hasStaticModels')]"
    },
    "hasModelDiscovery": {
      "type": "bool",
      "value": "[variables('hasModelDiscovery')]"
    },
    "hasCustomHeaders": {
      "type": "bool",
      "value": "[variables('hasCustomHeaders')]"
    }
  }
}